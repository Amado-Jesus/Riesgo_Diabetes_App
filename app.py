# -*- coding: utf-8 -*-
"""03_Aplicaciones.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1whXDDNdBl1Vij4fNHOqnyKD1pdgSocGx
"""

import streamlit as st
import pandas as pd
import joblib

# ------------------------------
# Configuraci√≥n de la app
# ------------------------------
st.set_page_config(
    page_title="Detecci√≥n de Riesgo de Diabetes",
    layout="centered"
)

st.title("ü©∫ Detecci√≥n de Riesgo de Diabetes")
st.write(
    "Aplicaci√≥n cl√≠nica para la predicci√≥n autom√°tica del riesgo de diabetes "
    "a partir de variables metab√≥licas."
)

# ------------------------------
# Cargar modelo
# ------------------------------
@st.cache_resource
def cargar_modelo():
    return joblib.load("modelo_svc.pkl")

modelo = cargar_modelo()

# ------------------------------
# Subida de archivo
# ------------------------------
archivo = st.file_uploader(
    "üìÇ Cargue el archivo CSV del paciente",
    type=["csv"]
)

if archivo is not None:
    df = pd.read_csv(archivo)

    st.subheader("üìä Vista previa de los datos")
    st.dataframe(df.head())

    # ------------------------------
    # Verificaci√≥n de columnas
    # ------------------------------
    columnas_esperadas = [
        'sexo', 'edad', 'imc', 'glu_suero',
        'trig', 'col_hdl', 'insulina', 'ac_urico'
    ]

    if not all(col in df.columns for col in columnas_esperadas):
        st.error(
            "‚ùå El archivo no contiene todas las columnas requeridas.\n\n"
            f"Columnas esperadas:\n{columnas_esperadas}"
        )
    else:
        # ------------------------------
        # Predicci√≥n
        # ------------------------------
        st.subheader("üîÆ Predicci√≥n del modelo")

        predicciones = modelo.predict(df[columnas_esperadas])

        df_resultado = df.copy()
        df_resultado["riesgo_diabetes"] = predicciones
        df_resultado["riesgo_diabetes"] = df_resultado["riesgo_diabetes"].map({
            0: "Riesgo bajo",
            1: "Riesgo alto"
        })

        st.success("‚úÖ Predicciones generadas correctamente")

        st.dataframe(df_resultado.head())

        # ------------------------------
        # Descargar resultados
        # ------------------------------
        csv_resultado = df_resultado.to_csv(index=False).encode("utf-8")

        st.download_button(
            label="‚¨áÔ∏è Descargar archivo etiquetado",
            data=csv_resultado,
            file_name="predicciones_riesgo_diabetes.csv",
            mime="text/csv"
        )

# ------------------------------
# Footer
# ------------------------------
st.markdown("---")
st.caption(
    "‚ö†Ô∏è Esta herramienta es de apoyo cl√≠nico y no sustituye el juicio m√©dico."
)